# rules.yaml
version: v1
rules:
  - id: "rule_heating_rate_001"
    name: "升温速率检查"
    description: "检查加热阶段温升速率是否在允许范围内"
    category: "process_compliance"
    inputs:
      - name: "temperature"
        description: "温度传感器数据"
        data_column: "ptc1"
        required: true
    parameters:
      - name: "max_rate" # 规则参数
        type: "float" # 参数类型
        required: true # 是否必填
        default: 2.0 # 默认值
        description: "最大允许升温速率(℃/min)" # 参数描述
    expression: | # 本地执行器表达式：直接返回布尔或数值/对象
      compare(max_rate, ">=", max(temperature_rate))

  - id: "rule_temperature_stability_001"
    name: "保温温度稳定性检查"
    description: "检查保温阶段温度波动是否在允许范围内"
    category: "process_compliance"
    inputs:
      - name: "temperature_group"
        description: "温度传感器组数据"
        data_column: "temperature_group"
        required: true
    parameters:
      - name: "max_std"
        type: "float"
        required: true
        default: 2.0
        description: "最大允许标准偏差(℃)"
    expression: |
      # 假设 temperature_group 为数值数组（平均温度序列），本地执行器不做矩阵操作
      compare(params.max_std, ">=", max(temperature_group) - min(temperature_group))

  - id: "rule_multi_sensor_temperature_001"
    name: "多传感器温度一致性检查"
    description: "检查PTC1和PTC2传感器温度差异是否在允许范围内"
    category: "process_compliance"
    inputs:
      - name: "ptc1_temperature"
        description: "PTC1温度传感器数据"
        data_column: "ptc1"
        required: true
      - name: "ptc2_temperature"
        description: "PTC2温度传感器数据"
        data_column: "ptc2"
        required: true
    parameters:
      - name: "max_temp_diff"
        type: "float"
        required: true
        default: 5.0
        description: "最大允许温度差异(℃)"
    expression: |
      compare(params.max_temp_diff, ">=", max(abs(ptc1_temperature - ptc2_temperature)))

  - id: "rule_pressure_check_001"
    name: "压力检查"
    description: "检查固化压力是否在指定范围内"
    category: "process_compliance"
    inputs:
      - name: "pressure"
        description: "压力传感器数据"
        data_column: "pressure"
        required: true
    parameters:
      - name: "min_pressure"
        type: "float"
        required: true
        default: 0.5
        description: "最小压力(MPa)"
      - name: "max_pressure"
        type: "float"
        required: true
        default: 2.0
        description: "最大压力(MPa)"
    expression: |
      in_range(avg(pressure), params.min_pressure, params.max_pressure)

  - id: "rule_sensor_group_max_check_001"
    name: "传感器组最大值检查"
    description: "检查多个传感器的最大值都要大于指定阈值"
    category: "process_compliance"
    inputs:
      - name: "temperature_group"
        description: "温度传感器组数据"
        data_column: "temperature_group"
        required: true
        aggregation: "max"  # 指定聚合方式
    parameters:
      - name: "threshold"
        type: "float"
        required: true
        default: 100.0
        description: "最小阈值(℃)"
    expression: |
      all(max(temperature_group) >= params.threshold)

  - id: "rule_sensor_group_min_check_001"
    name: "传感器组最小值检查"
    description: "检查多个传感器的最小值都要小于指定阈值"
    category: "process_compliance"
    inputs:
      - name: "temperature_group"
        description: "温度传感器组数据"
        data_column: "temperature_group"
        required: true
    parameters:
      - name: "threshold"
        type: "float"
        required: true
        default: 50.0
        description: "最大阈值(℃)"
    expression: |
      all(min(temperature_group) <= params.threshold)

  - id: "rule_sensor_group_avg_check_001"
    name: "传感器组平均值检查"
    description: "检查多个传感器的平均值在指定范围内"
    category: "process_compliance"
    inputs:
      - name: "temperature_group"
        description: "温度传感器组数据"
        data_column: "temperature_group"
        required: true
    parameters:
      - name: "min_threshold"
        type: "float"
        required: true
        default: 95.0
        description: "最小阈值(℃)"
      - name: "max_threshold"
        type: "float"
        required: true
        default: 105.0
        description: "最大阈值(℃)"
    expression: |
      in_range(avg(temperature_group), params.min_threshold, params.max_threshold)

  - id: "rule_cooling_rate_001"
    name: "降温速率检查"
    description: "检查冷却阶段降温速率是否合理"
    category: "process_compliance"
    inputs:
      - name: "temperature_group"
        description: "温度传感器组数据"
        data_column: "temperature_group"
        required: true
    parameters:
      - name: "max_cooling_rate"
        type: "float"
        required: true
        default: -0.5
        description: "最大允许降温速率(℃/min，负值表示降温)"
    expression: |
      rate(temperature_group) >= params.max_cooling_rate